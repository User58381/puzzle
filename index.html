<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Puzles de Matemáticas</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1{
      text-align:center;
    }
    .config{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      margin-bottom:1rem;
      border:1px solid #ccc;
      padding:1rem;
      border-radius:8px;
    }
    .config label{
      display:block;
      font-size:0.9rem;
      margin-bottom:0.25rem;
    }
    textarea{
      width:100%;
      min-height:60px;
    }
    #preview{
      margin-top:20px;
      border:1px solid #000;
      padding:10px;
    }
    .sheet{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:10px;
      page-break-after:always;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border:2px solid #000;
      padding:4px;
      text-align:center;
    }
    .puzzle-table img{
      width:100%;
      height:auto;
      display:block;
    }
    .small-note{
      font-size:0.8rem;
      color:#555;
    }
    .btn-print{
      margin-left:10px;
    }
    @media print{
      body{ margin:0; }
      .config{ display:none; }
      #preview{ border:none; padding:0; }
      table td{ font-size:18px !important; }
      img{ max-width:100%; }
    }
  </style>
</head>
<body>
<h1>Puzles de Matemáticas</h1>

<div class="config">
  <div>
    <label>Imagen del puzle:</label>
    <input type="file" id="imgInput" accept="image/*">
  </div>

  <div>
    <label>Tamaño:</label>
    <select id="sizeSelect">
      <option value="3x4">3 x 4 (12 piezas)</option>
      <option value="3x5">3 x 5 (15 piezas)</option>
      <option value="4x5">4 x 5 (20 piezas)</option>
    </select>
  </div>

  <div style="flex:1 1 100%;">
    <label>Operaciones (separadas por espacio):</label>
    <textarea id="opsInput"
      placeholder="Ejemplo: 5+3 7+2 4+6 9+1 8+2 3+5 ..."></textarea>
    <div class="small-note">
      Se admiten + - * /, paréntesis, x · : y decimales con coma o punto.
    </div>
  </div>

  <div>
    <button id="generateBtn">Generar ficha</button>
    <button class="btn-print" onclick="window.print()">Imprimir (puzle + solución)</button>
  </div>
</div>

<div id="preview"></div>

<script>
const imgInput   = document.getElementById('imgInput');
const sizeSelect = document.getElementById('sizeSelect');
const opsInput   = document.getElementById('opsInput');
const preview    = document.getElementById('preview');
const generateBtn= document.getElementById('generateBtn');

let loadedImage = null;

// Cargar imagen en memoria
imgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = ()=>{
      loadedImage = img;
      alert("Imagen cargada correctamente");
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Normalizar y calcular una operación
function computeOp(opStr){
  let expr = opStr.trim();
  expr = expr.replace(/x|X|·/g, '*');
  expr = expr.replace(/:/g, '/');
  expr = expr.replace(/,/g, '.');

  if(!/^[0-9+\-*/().\s]+$/.test(expr)){
    throw new Error("Carácter no permitido en operación: " + opStr);
  }

  const fn = new Function("return ("+expr+")");
  const val = fn();
  return Math.round((val + Number.EPSILON) * 100) / 100; // 2 decimales
}

// Corta la imagen en piezas y devuelve array de dataURLs
function sliceImage(img, rows, cols){
  const tileWidth  = img.width / cols;
  const tileHeight = img.height / rows;
  const pieces = [];

  const tempCanvas = document.createElement('canvas');
  const ctx = tempCanvas.getContext('2d');
  tempCanvas.width  = tileWidth;
  tempCanvas.height = tileHeight;

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      ctx.clearRect(0,0,tileWidth,tileHeight);
      ctx.drawImage(
        img,
        c*tileWidth, r*tileHeight, tileWidth, tileHeight,
        0, 0, tileWidth, tileHeight
      );
      pieces.push(tempCanvas.toDataURL());
    }
  }
  return pieces;
}

// Mezclar piezas y resultados a la vez
function shufflePuzzle(pieces, results){
  for(let i = pieces.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [pieces[i], pieces[j]] = [pieces[j], pieces[i]];
    [results[i], results[j]] = [results[j], results[i]];
  }
}

generateBtn.addEventListener('click', ()=>{
  if(!loadedImage){
    alert("Primero selecciona una imagen.");
    return;
  }

  const [rows, cols] = sizeSelect.value.split('x').map(Number);
  const expected = rows * cols;

  const opsRaw = opsInput.value.trim();
  if(!opsRaw){
    alert("Escribe las operaciones.");
    return;
  }

  const ops = opsRaw.split(/\s+/);
  if(ops.length !== expected){
    alert("Se necesitan exactamente " + expected +
          " operaciones para un puzle " + rows + "x" + cols +
          ". Ahora hay " + ops.length + ".");
    return;
  }

  let results = [];
  try{
    results = ops.map(computeOp);
  }catch(err){
    alert("Error al calcular: " + err.message);
    return;
  }

  const pieces = sliceImage(loadedImage, rows, cols);

  // Mezclar orden de piezas y resultados
  shufflePuzzle(pieces, results);

  preview.innerHTML = ""; // limpiar

  // --- HOJA 1: FICHA DEL ALUMNO (operaciones + puzle mezclado) ---
  const sheet = document.createElement('div');
  sheet.className = 'sheet';

  // Tabla de operaciones
  const opTable = document.createElement('table');
  const opHead = document.createElement('tr');
  opHead.innerHTML = '<th colspan="'+cols+'">TALLER DE MATES - Operaciones</th>';
  opTable.appendChild(opHead);

  let idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.textContent = ops[idx++];
      tr.appendChild(td);
    }
    opTable.appendChild(tr);
  }

  // Tabla de puzle
  const puzzleTable = document.createElement('table');
  puzzleTable.className = 'puzzle-table';
  const pHead = document.createElement('tr');
  pHead.innerHTML = '<th colspan="'+cols+'">Puzle</th>';
  puzzleTable.appendChild(pHead);

  idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = pieces[idx];

      const num = document.createElement('div');
      num.textContent = results[idx];
      num.style.fontSize = "32px";
      num.style.fontWeight = "bold";
      num.style.color = "red";
      num.style.position = "absolute";
      num.style.top = "50%";
      num.style.left = "50%";
      num.style.transform = "translate(-50%, -50%)";

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      idx++;
    }
    puzzleTable.appendChild(tr);
  }

  sheet.appendChild(opTable);
  sheet.appendChild(puzzleTable);
  preview.appendChild(sheet);

  // --- HOJA 2: SOLUCIÓN (imagen completa + tabla de resultados) ---
  const solutionSheet = document.createElement('div');
  solutionSheet.className = 'sheet';
  solutionSheet.style.pageBreakBefore = "always";

  // columna izquierda: imagen completa
  const fullImgContainer = document.createElement('div');
  const fullImg = document.createElement('img');
  fullImg.src = loadedImage.src;
  fullImg.style.width = "100%";
  fullImg.style.border = "1px solid black";
  fullImgContainer.appendChild(fullImg);

  // columna derecha: tabla de resultados
  const solTable = document.createElement('table');
  const header = document.createElement('tr');
  header.innerHTML = '<th colspan="'+cols+'">SOLUCIÓN - Resultados</th>';
  solTable.appendChild(header);

  let k = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.textContent = results[k++];
      td.style.fontSize = "20px";
      td.style.fontWeight = "bold";
      tr.appendChild(td);
    }
    solTable.appendChild(tr);
  }

  solutionSheet.appendChild(fullImgContainer);
  solutionSheet.appendChild(solTable);
  preview.appendChild(solutionSheet);

  const note = document.createElement('p');
  note.className = "small-note";
  note.textContent = "Para imprimir, usa el menú del navegador: Archivo → Imprimir → Guardar como PDF.";
  preview.appendChild(note);
});
</script>
</body>
</html>
