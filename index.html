<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Aula Digital QR – Puzzles de Cálculo Mental</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      margin: 20px;
      background:#f0f0f0;
    }
    h1{
      text-align:center;
      margin-bottom:4px;
    }
    .brand{
      font-size:0.85rem;
      color:#666;
      text-align:center;
      margin-bottom:12px;
    }
    .config{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      margin-bottom:1rem;
      border:1px solid #ccc;
      padding:1rem;
      border-radius:8px;
      background:white;
    }
    .config label{
      display:block;
      font-size:0.9rem;
      margin-bottom:0.25rem;
    }
    textarea{
      width:100%;
      min-height:60px;
    }
    #preview{
      margin-top:20px;
      border:1px solid #000;
      padding:10px;
      background:white;
    }
    /* hoja con dos columnas: izquierda operaciones, derecha puzzle */
    .sheet{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      page-break-after:always;
      margin-bottom:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border:2px solid #000;
      padding:4px;
      text-align:center;
    }
    thead th{
      background:#f5f5f5;
      font-weight:bold;
    }
    .puzzle-table img{
      width:100%;
      height:auto;
      display:block;
    }
    .small-note{
      font-size:0.8rem;
      color:#555;
    }
    .btn-print{
      margin-left:10px;
    }
    /* En impresión NO cambiamos tamaños, solo ocultamos la zona de configuración */
    @media print{
      body{ margin:0; background:white; }
      .config{ display:none; }
      #preview{ border:none; padding:0; }
    }
  </style>
</head>
<body>
<h1>Aula Digital QR – Puzzles de Cálculo Mental</h1>
<div class="brand">Generador profesional de fichas de cálculo mental y puzzles para el aula</div>

<div class="config">
  <div>
    <label>Imagen del puzzle:</label>
    <input type="file" id="imgInput" accept="image/*">
  </div>

  <div>
    <label>Tamaño de cuadrícula:</label>
    <select id="sizeSelect">
      <option value="3x4">3 x 4 (12 piezas)</option>
      <option value="3x5">3 x 5 (15 piezas)</option>
      <option value="4x5">4 x 5 (20 piezas)</option>
    </select>
  </div>

  <div style="flex:1 1 100%;">
    <label>Operaciones (separadas por espacio):</label>
    <textarea id="opsInput"
      placeholder="Ejemplo: 2+3 4+2 5+3 6+4 7+5 9-2 9+6 10+3 11+8 18-9 8*2 7*2"></textarea>
    <div class="small-note">
      El sistema admite + - * /, paréntesis, x · : y decimales con coma o punto.
    </div>
  </div>

  <div>
    <button id="generateBtn">Generar puzzle</button>
    <button class="btn-print" onclick="window.print()">Imprimir (puzzle + solución)</button>
    <button class="btn-print" id="pdfBtn">Descargar PDF (puzzle + solución)</button>
  </div>
</div>

<div id="preview"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
const imgInput   = document.getElementById('imgInput');
const sizeSelect = document.getElementById('sizeSelect');
const opsInput   = document.getElementById('opsInput');
const preview    = document.getElementById('preview');
const generateBtn= document.getElementById('generateBtn');
const pdfBtn     = document.getElementById('pdfBtn');

let loadedImage = null;

// Cargar imagen
imgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = ()=>{
      loadedImage = img;
      alert("Imagen del puzzle cargada correctamente");
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Máximo común divisor para simplificar fracciones
function gcd(a, b){
  a = Math.abs(a);
  b = Math.abs(b);
  while (b !== 0){
    const t = b;
    b = a % b;
    a = t;
  }
  return a;
}

// Normalizar y calcular una operación
// Ahora devuelve fracciones simplificadas para expresiones tipo a/b + c/d o a/b - c/d.
function computeOp(opStr){
  let expr = opStr.trim();
  expr = expr.replace(/x|X|·/g, '*');
  expr = expr.replace(/:/g, '/');
  expr = expr.replace(/,/g, '.');

  // Intentar detectar fracción del tipo a/b +/- c/d
  const fracPattern = /^(\d+)\s*\/\s*(\d+)\s*([+\-])\s*(\d+)\s*\/\s*(\d+)$/;
  const m = expr.match(fracPattern);

  if(m){
    const a = parseInt(m[1], 10);
    const b = parseInt(m[2], 10);
    const sign = m[3];
    const c = parseInt(m[4], 10);
    const d = parseInt(m[5], 10);

    // a/b ± c/d = (a*d ± c*b) / (b*d)
    let num = a*d + (sign === '+' ? 1 : -1)*c*b;
    let den = b*d;

    // Simplificar fracción
    const g = gcd(num, den);
    num /= g;
    den /= g;

    return num + "/" + den;   // Devolvemos fracción como texto
  }

  // Si no es una suma/resta simple de fracciones, usar cálculo decimal como antes
  if(!/^[0-9+\-*/().\s]+$/.test(expr)){
    throw new Error("Carácter no permitido en operación: " + opStr);
  }

  const fn = new Function("return ("+expr+")");
  const val = fn();
  return Math.round((val + Number.EPSILON) * 100) / 100;
}

// Corta imagen en piezas cuadradas
function sliceImage(img, rows, cols){
  const tileWidth  = img.width / cols;
  const tileHeight = img.height / rows;
  const pieces = [];

  const tempCanvas = document.createElement('canvas');
  const ctx = tempCanvas.getContext('2d');
  tempCanvas.width  = tileWidth;
  tempCanvas.height = tileHeight;

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      ctx.clearRect(0,0,tileWidth,tileHeight);
      ctx.drawImage(
        img,
        c*tileWidth, r*tileHeight, tileWidth, tileHeight,
        0, 0, tileWidth, tileHeight
      );
      pieces.push(tempCanvas.toDataURL());
    }
  }
  return pieces;
}

// Mezclar array
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Estilo de número blanco con borde negro
function styleNumber(div){
  div.style.fontSize = "32px";
  div.style.fontWeight = "bold";
  div.style.color = "white";
  div.style.position = "absolute";
  div.style.top = "50%";
  div.style.left = "50%";
  div.style.transform = "translate(-50%, -50%)";
  div.style.textShadow =
    "-1px -1px 2px black, 1px -1px 2px black, -1px 1px 2px black, 1px 1px 2px black";
}

// Sincronizar alturas de filas para que cuadren cuadros de operaciones y puzzle
function syncRowHeights(opTable, puzzleTable){
  const opBody = opTable.tBodies[0];
  const puzzleBody = puzzleTable.tBodies[0];
  if(!opBody || !puzzleBody) return;

  const opRows = opBody.rows;
  const puzzleRows = puzzleBody.rows;
  const len = Math.min(opRows.length, puzzleRows.length);

  for(let i=0; i<len; i++){
    const h = puzzleRows[i].getBoundingClientRect().height;
    opRows[i].style.height = h + 'px';
  }
}

// Esperar a que carguen todas las imágenes del puzzle
function syncWhenImagesReady(opTable, puzzleTable){
  const imgs = puzzleTable.querySelectorAll('img');
  let remaining = imgs.length;
  if(remaining === 0){
    syncRowHeights(opTable, puzzleTable);
    return;
  }
  imgs.forEach(img=>{
    if(img.complete){
      remaining--;
      if(remaining === 0) syncRowHeights(opTable, puzzleTable);
    }else{
      img.onload = ()=>{
        remaining--;
        if(remaining === 0) syncRowHeights(opTable, puzzleTable);
      };
    }
  });
}

generateBtn.addEventListener('click', ()=>{
  if(!loadedImage){
    alert("Primero selecciona una imagen para el puzzle.");
    return;
  }

  const [rows, cols] = sizeSelect.value.split('x').map(Number);
  const expected = rows * cols;

  const opsRaw = opsInput.value.trim();
  if(!opsRaw){
    alert("Escribe las operaciones que quieres trabajar.");
    return;
  }

  const ops = opsRaw.split(/\s+/);
  if(ops.length !== expected){
    alert("Se necesitan exactamente " + expected +
          " operaciones para un puzzle " + rows + "x" + cols +
          ". Ahora hay " + ops.length + ".");
    return;
  }

  let results = [];
  try{
    results = ops.map(computeOp);
  }catch(err){
    alert("Error al calcular una operación: " + err.message);
    return;
  }

  const pieces = sliceImage(loadedImage, rows, cols);

  const cells = [];
  for(let i=0; i<expected; i++){
    cells.push({
      op: ops[i],
      result: results[i],
      piece: pieces[i]
    });
  }

  const shuffled = cells.slice();
  shuffleArray(shuffled);

  preview.innerHTML = "";

  // -------- HOJA 1: alumno (operaciones + puzzle mezclado) ----------
  const sheet = document.createElement('div');
  sheet.className = 'sheet';

  // Tabla operaciones
  const opTable = document.createElement('table');
  const opThead = document.createElement('thead');
  const opHeadRow = document.createElement('tr');
  opHeadRow.innerHTML = '<th colspan="'+cols+'">Taller de cálculo mental – Operaciones</th>';
  opThead.appendChild(opHeadRow);
  opTable.appendChild(opThead);

  const opTbody = document.createElement('tbody');
  let idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.textContent = cells[idx].op;
      tr.appendChild(td);
      idx++;
    }
    opTbody.appendChild(tr);
  }
  opTable.appendChild(opTbody);

  // Tabla puzzle mezclado
  const puzzleTable = document.createElement('table');
  puzzleTable.className = 'puzzle-table';
  const pThead = document.createElement('thead');
  const pHeadRow = document.createElement('tr');
  pHeadRow.innerHTML = '<th colspan="'+cols+'">Puzzle de Aula Digital QR</th>';
  pThead.appendChild(pHeadRow);
  puzzleTable.appendChild(pThead);

  const pTbody = document.createElement('tbody');
  idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const cell = shuffled[idx];
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;  // ahora muestra fracción
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      idx++;
    }
    pTbody.appendChild(tr);
  }
  puzzleTable.appendChild(pTbody);

  sheet.appendChild(opTable);
  sheet.appendChild(puzzleTable);
  preview.appendChild(sheet);

  // Igualar alturas de filas (para que los cuadros coincidan)
  syncWhenImagesReady(opTable, puzzleTable);

  // -------- HOJA 2: solución (puzzle armado) ----------
  const solutionSheet = document.createElement('div');
  solutionSheet.className = 'sheet';
  solutionSheet.style.gridTemplateColumns = '1fr';

  const solTable = document.createElement('table');
  solTable.className = 'puzzle-table';
  const sThead = document.createElement('thead');
  const sHeadRow = document.createElement('tr');
  sHeadRow.innerHTML = '<th colspan="'+cols+'">Solución – Puzzle armado con resultados</th>';
  sThead.appendChild(sHeadRow);
  solTable.appendChild(sThead);

  const sTbody = document.createElement('tbody');
  let k = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const cell = cells[k];
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;  // fracción también en la solución
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      k++;
    }
    sTbody.appendChild(tr);
  }
  solTable.appendChild(sTbody);
  solutionSheet.appendChild(solTable);
  preview.appendChild(solutionSheet);

  const note = document.createElement('p');
  note.className = "small-note";
  note.textContent =
    "Documento generado con Aula Digital QR – Puzzles de Cálculo Mental.";
  preview.appendChild(note);
});

// PDF (puzzle + solución)
pdfBtn.addEventListener('click', ()=>{
  if(!preview.firstChild){
    alert("Primero genera un puzzle antes de descargar el PDF.");
    return;
  }

  const element = document.getElementById('preview');
  const opt = {
    margin:       10,
    filename:     'AulaDigitalQR_Puzzle_Matematicas.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  {
      scale: 2,
      windowWidth: element.scrollWidth   // captura con el ancho real
    },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };
  html2pdf().set(opt).from(element).save();
});
</script>
</body>
</html>
