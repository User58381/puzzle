<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Puzles de Matemáticas</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1{
      text-align:center;
    }
    .config{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      margin-bottom:1rem;
      border:1px solid #ccc;
      padding:1rem;
      border-radius:8px;
    }
    .config label{
      display:block;
      font-size:0.9rem;
      margin-bottom:0.25rem;
    }
    textarea{
      width:100%;
      min-height:60px;
    }
    #preview{
      margin-top:20px;
      border:1px solid #000;
      padding:10px;
    }
    .sheet{
      display:grid;
      grid-template-columns:1fr 1fr; /* mismo ancho para operaciones y puzle */
      gap:10px;
      page-break-after:always;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border:2px solid #000;
      padding:4px;
      text-align:center;
    }
    thead th{
      background:#f5f5f5;
      font-weight:bold;
    }
    .puzzle-table img{
      width:100%;
      height:auto;
      display:block;
    }
    .small-note{
      font-size:0.8rem;
      color:#555;
    }
    .btn-print{
      margin-left:10px;
    }
    @media print{
      body{ margin:0; }
      .config{ display:none; }
      #preview{ border:none; padding:0; }
      table td{ font-size:18px !important; }
      img{ max-width:100%; }
    }
  </style>
</head>
<body>
<h1>Puzles de Matemáticas</h1>

<div class="config">
  <div>
    <label>Imagen del puzle:</label>
    <input type="file" id="imgInput" accept="image/*">
  </div>

  <div>
    <label>Tamaño:</label>
    <select id="sizeSelect">
      <option value="3x4">3 x 4 (12 piezas)</option>
      <option value="3x5">3 x 5 (15 piezas)</option>
      <option value="4x5">4 x 5 (20 piezas)</option>
    </select>
  </div>

  <div style="flex:1 1 100%;">
    <label>Operaciones (separadas por espacio):</label>
    <textarea id="opsInput"
      placeholder="Ejemplo: 2+3 4+2 5+3 6+4 7+5 8+6 9+7 10+8 11+9 12+10 13+11 14+12"></textarea>
    <div class="small-note">
      Se admiten + - * /, paréntesis, x · : y decimales con coma o punto.
    </div>
  </div>

  <div>
    <button id="generateBtn">Generar ficha</button>
    <button class="btn-print" onclick="window.print()">Imprimir (puzle + solución)</button>
  </div>
</div>

<div id="preview"></div>

<script>
const imgInput   = document.getElementById('imgInput');
const sizeSelect = document.getElementById('sizeSelect');
const opsInput   = document.getElementById('opsInput');
const preview    = document.getElementById('preview');
const generateBtn= document.getElementById('generateBtn');

let loadedImage = null;

// Cargar imagen en memoria
imgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = ()=>{
      loadedImage = img;
      alert("Imagen cargada correctamente");
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Normalizar y calcular una operación
function computeOp(opStr){
  let expr = opStr.trim();
  expr = expr.replace(/x|X|·/g, '*');
  expr = expr.replace(/:/g, '/');
  expr = expr.replace(/,/g, '.');

  if(!/^[0-9+\-*/().\s]+$/.test(expr)){
    throw new Error("Carácter no permitido en operación: " + opStr);
  }

  const fn = new Function("return ("+expr+")");
  const val = fn();
  return Math.round((val + Number.EPSILON) * 100) / 100; // 2 decimales
}

// Corta la imagen en piezas y devuelve array de dataURLs
function sliceImage(img, rows, cols){
  const tileWidth  = img.width / cols;
  const tileHeight = img.height / rows;
  const pieces = [];

  const tempCanvas = document.createElement('canvas');
  const ctx = tempCanvas.getContext('2d');
  tempCanvas.width  = tileWidth;
  tempCanvas.height = tileHeight;

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      ctx.clearRect(0,0,tileWidth,tileHeight);
      ctx.drawImage(
        img,
        c*tileWidth, r*tileHeight, tileWidth, tileHeight,
        0, 0, tileWidth, tileHeight
      );
      pieces.push(tempCanvas.toDataURL());
    }
  }
  return pieces;
}

// Mezclar array genérico (para las celdas)
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Aplica estilo "blanco con contorno negro" a los números
function styleNumber(div){
  div.style.fontSize = "32px";
  div.style.fontWeight = "bold";
  div.style.color = "white";
  div.style.position = "absolute";
  div.style.top = "50%";
  div.style.left = "50%";
  div.style.transform = "translate(-50%, -50%)";
  // contorno negro con sombra
  div.style.textShadow =
    "-1px -1px 2px black, 1px -1px 2px black, -1px 1px 2px black, 1px 1px 2px black";
}

// Igualar alturas de filas entre tabla de operaciones y puzle (solo tbody)
function syncRowHeights(opTable, puzzleTable){
  const opBody = opTable.tBodies[0];
  const puzzleBody = puzzleTable.tBodies[0];
  if(!opBody || !puzzleBody) return;

  const opRows = opBody.rows;
  const puzzleRows = puzzleBody.rows;
  const len = Math.min(opRows.length, puzzleRows.length);

  for(let i=0; i<len; i++){
    const h = puzzleRows[i].getBoundingClientRect().height;
    opRows[i].style.height = h + 'px';
  }
}

// Espera a que carguen todas las imágenes del puzle y luego sincroniza alturas
function syncWhenImagesReady(opTable, puzzleTable){
  const imgs = puzzleTable.querySelectorAll('img');
  let remaining = imgs.length;
  if(remaining === 0){
    syncRowHeights(opTable, puzzleTable);
    return;
  }
  imgs.forEach(img=>{
    if(img.complete){
      remaining--;
      if(remaining === 0) syncRowHeights(opTable, puzzleTable);
    }else{
      img.onload = ()=>{
        remaining--;
        if(remaining === 0) syncRowHeights(opTable, puzzleTable);
      };
    }
  });
}

generateBtn.addEventListener('click', ()=>{
  if(!loadedImage){
    alert("Primero selecciona una imagen.");
    return;
  }

  const [rows, cols] = sizeSelect.value.split('x').map(Number);
  const expected = rows * cols;

  const opsRaw = opsInput.value.trim();
  if(!opsRaw){
    alert("Escribe las operaciones.");
    return;
  }

  const ops = opsRaw.split(/\s+/);
  if(ops.length !== expected){
    alert("Se necesitan exactamente " + expected +
          " operaciones para un puzle " + rows + "x" + cols +
          ". Ahora hay " + ops.length + ".");
    return;
  }

  // Resultados en el orden original de las operaciones
  let results = [];
  try{
    results = ops.map(computeOp);
  }catch(err){
    alert("Error al calcular: " + err.message);
    return;
  }

  const pieces = sliceImage(loadedImage, rows, cols);

  // Estructura que mantiene vínculo operación–resultado–pieza
  const total = expected;
  const cells = [];
  for(let i=0; i<total; i++){
    cells.push({
      op: ops[i],
      result: results[i],
      piece: pieces[i]
    });
  }

  // Versión mezclada para el puzle del alumno
  const shuffled = cells.slice();
  shuffleArray(shuffled);

  preview.innerHTML = ""; // limpiar

  // --- HOJA 1: FICHA DEL ALUMNO (operaciones + puzle mezclado) ---
  const sheet = document.createElement('div');
  sheet.className = 'sheet';

  // Tabla de operaciones (en orden original)
  const opTable = document.createElement('table');
  const opThead = document.createElement('thead');
  const opHeadRow = document.createElement('tr');
  opHeadRow.innerHTML = '<th colspan="'+cols+'">TALLER DE MATES - Operaciones</th>';
  opThead.appendChild(opHeadRow);
  opTable.appendChild(opThead);

  const opTbody = document.createElement('tbody');
  let idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.textContent = cells[idx].op;
      tr.appendChild(td);
      idx++;
    }
    opTbody.appendChild(tr);
  }
  opTable.appendChild(opTbody);

  // Tabla de puzle MEZCLADA
  const puzzleTable = document.createElement('table');
  puzzleTable.className = 'puzzle-table';
  const pThead = document.createElement('thead');
  const pHeadRow = document.createElement('tr');
  pHeadRow.innerHTML = '<th colspan="'+cols+'">Puzle</th>';
  pThead.appendChild(pHeadRow);
  puzzleTable.appendChild(pThead);

  const pTbody = document.createElement('tbody');
  idx = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const cell = shuffled[idx];
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      idx++;
    }
    pTbody.appendChild(tr);
  }
  puzzleTable.appendChild(pTbody);

  sheet.appendChild(opTable);
  sheet.appendChild(puzzleTable);
  preview.appendChild(sheet);

  // Sincronizar alturas de filas (después de cargar imágenes)
  syncWhenImagesReady(opTable, puzzleTable);

  // --- HOJA 2: SOLUCIÓN (imagen armada con números en su lugar) ---
  const solutionSheet = document.createElement('div');
  solutionSheet.className = 'sheet';
  solutionSheet.style.gridTemplateColumns = '1fr'; // solo una columna, ancho completo

  const solTable = document.createElement('table');
  solTable.className = 'puzzle-table';
  const sThead = document.createElement('thead');
  const sHeadRow = document.createElement('tr');
  sHeadRow.innerHTML = '<th colspan="'+cols+'">SOLUCIÓN - Imagen armada</th>';
  sThead.appendChild(sHeadRow);
  solTable.appendChild(sThead);

  const sTbody = document.createElement('tbody');
  let k = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const cell = cells[k]; // SIN MEZCLAR: imagen armada correcta
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      k++;
    }
    sTbody.appendChild(tr);
  }
  solTable.appendChild(sTbody);

  solutionSheet.appendChild(solTable);
  preview.appendChild(solutionSheet);

  const note = document.createElement('p');
  note.className = "small-note";
  note.textContent = "Para imprimir, usa el menú del navegador: Archivo → Imprimir → Guardar como PDF.";
  preview.appendChild(note);
});
</script>
</body>
</html>
