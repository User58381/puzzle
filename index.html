<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Aula Digital QR – Puzzles de Cálculo Mental</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      margin: 20px;
      background:#f0f0f0;
    }
    h1{
      text-align:center;
      margin-bottom:4px;
    }
    .brand{
      font-size:0.85rem;
      color:#666;
      text-align:center;
      margin-bottom:12px;
    }
    .config{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      margin-bottom:1rem;
      border:1px solid #ccc;
      padding:1rem;
      border-radius:8px;
      background:white;
    }
    .config label{
      display:block;
      font-size:0.9rem;
      margin-bottom:0.25rem;
    }
    textarea{
      width:100%;
      min-height:60px;
    }
    #preview{
      margin-top:20px;
      border:1px solid #000;
      padding:10px;
      background:white;
    }
    .sheet{
      page-break-after:always;
      margin-bottom:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border:2px solid #000;
      padding:4px;
      text-align:center;
    }
    thead th{
      background:#f5f5f5;
      font-weight:bold;
    }
    .puzzle-table img{
      width:100%;
      height:auto;
      display:block;
    }
    .small-note{
      font-size:0.8rem;
      color:#555;
    }
    .btn-print{
      margin-left:10px;
    }
    /* IMPORTANTE: en impresión no cambiamos tamaños, solo ocultamos la config */
    @media print{
      body{ margin:0; background:white; }
      .config{ display:none; }
      #preview{ border:none; padding:0; }
    }
  </style>
</head>
<body>
<h1>Aula Digital QR – Puzzles de Cálculo Mental</h1>
<div class="brand">Generador profesional de fichas de cálculo mental y puzzles para el aula</div>

<div class="config">
  <div>
    <label>Imagen del puzzle:</label>
    <input type="file" id="imgInput" accept="image/*">
  </div>

  <div>
    <label>Tamaño de cuadrícula:</label>
    <select id="sizeSelect">
      <option value="3x4">3 x 4 (12 piezas)</option>
      <option value="3x5">3 x 5 (15 piezas)</option>
      <option value="4x5">4 x 5 (20 piezas)</option>
    </select>
  </div>

  <div style="flex:1 1 100%;">
    <label>Operaciones (separadas por espacio):</label>
    <textarea id="opsInput"
      placeholder="Ejemplo: 2+3 4+2 5+3 6+4 7+5 8+6 9+7 10+8 11+9 12+10 13+11 14+12"></textarea>
    <div class="small-note">
      El sistema admite + - * /, paréntesis, x · : y decimales con coma o punto.
    </div>
  </div>

  <div>
    <button id="generateBtn">Generar puzzle</button>
    <button class="btn-print" onclick="window.print()">Imprimir (puzzle + solución)</button>
    <button class="btn-print" id="pdfBtn">Descargar PDF (puzzle + solución)</button>
  </div>
</div>

<div id="preview"></div>

<!-- Librería para generar PDF en el navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
const imgInput   = document.getElementById('imgInput');
const sizeSelect = document.getElementById('sizeSelect');
const opsInput   = document.getElementById('opsInput');
const preview    = document.getElementById('preview');
const generateBtn= document.getElementById('generateBtn');
const pdfBtn     = document.getElementById('pdfBtn');

let loadedImage = null;

// Cargar imagen en memoria
imgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = ()=>{
      loadedImage = img;
      alert("Imagen del puzzle cargada correctamente");
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Normalizar y calcular una operación
function computeOp(opStr){
  let expr = opStr.trim();
  expr = expr.replace(/x|X|·/g, '*');
  expr = expr.replace(/:/g, '/');
  expr = expr.replace(/,/g, '.');

  if(!/^[0-9+\-*/().\s]+$/.test(expr)){
    throw new Error("Carácter no permitido en operación: " + opStr);
  }

  const fn = new Function("return ("+expr+")");
  const val = fn();
  return Math.round((val + Number.EPSILON) * 100) / 100; // 2 decimales
}

// Corta la imagen en piezas y devuelve array de dataURLs
function sliceImage(img, rows, cols){
  const tileWidth  = img.width / cols;
  const tileHeight = img.height / rows;
  const pieces = [];

  const tempCanvas = document.createElement('canvas');
  const ctx = tempCanvas.getContext('2d');
  tempCanvas.width  = tileWidth;
  tempCanvas.height = tileHeight;

  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      ctx.clearRect(0,0,tileWidth,tileHeight);
      ctx.drawImage(
        img,
        c*tileWidth, r*tileHeight, tileWidth, tileHeight,
        0, 0, tileWidth, tileHeight
      );
      pieces.push(tempCanvas.toDataURL());
    }
  }
  return pieces;
}

// Mezclar array genérico (para las celdas)
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Estilo "número blanco con contorno negro"
function styleNumber(div){
  div.style.fontSize = "32px";
  div.style.fontWeight = "bold";
  div.style.color = "white";
  div.style.position = "absolute";
  div.style.top = "50%";
  div.style.left = "50%";
  div.style.transform = "translate(-50%, -50%)";
  div.style.textShadow =
    "-1px -1px 2px black, 1px -1px 2px black, -1px 1px 2px black, 1px 1px 2px black";
}

generateBtn.addEventListener('click', ()=>{
  if(!loadedImage){
    alert("Primero selecciona una imagen para el puzzle.");
    return;
  }

  const [rows, cols] = sizeSelect.value.split('x').map(Number);
  const expected = rows * cols;

  const opsRaw = opsInput.value.trim();
  if(!opsRaw){
    alert("Escribe las operaciones que quieres trabajar.");
    return;
  }

  const ops = opsRaw.split(/\s+/);
  if(ops.length !== expected){
    alert("Se necesitan exactamente " + expected +
          " operaciones para un puzzle " + rows + "x" + cols +
          ". Ahora hay " + ops.length + ".");
    return;
  }

  // Resultados en el orden original de las operaciones
  let results = [];
  try{
    results = ops.map(computeOp);
  }catch(err){
    alert("Error al calcular una operación: " + err.message);
    return;
  }

  const pieces = sliceImage(loadedImage, rows, cols);

  // Estructura que mantiene vínculo operación–resultado–pieza
  const total = expected;
  const cells = [];
  for(let i=0; i<total; i++){
    cells.push({
      op: ops[i],
      result: results[i],
      piece: pieces[i]
    });
  }

  // Versión mezclada para el puzzle del alumno
  const shuffled = cells.slice();
  shuffleArray(shuffled);

  preview.innerHTML = ""; // limpiar

  // --- HOJA 1: FICHA DEL ALUMNO (tabla única: operaciones + puzzle) ---
  const sheet1 = document.createElement('div');
  sheet1.className = 'sheet';

  const mainTable = document.createElement('table');

  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  const thOps = document.createElement('th');
  thOps.colSpan = cols;
  thOps.textContent = "Taller de cálculo mental – Operaciones";

  const thPuzzle = document.createElement('th');
  thPuzzle.colSpan = cols;
  thPuzzle.textContent = "Puzzle de Aula Digital QR";

  headRow.appendChild(thOps);
  headRow.appendChild(thPuzzle);
  thead.appendChild(headRow);
  mainTable.appendChild(thead);

  const tbody = document.createElement('tbody');
  let idxShuffled = 0;
  let idxCells    = 0;

  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');

    // celdas de operaciones (orden original)
    for(let c=0; c<cols; c++){
      const td = document.createElement('td');
      td.textContent = cells[idxCells].op;
      tr.appendChild(td);
      idxCells++;
    }

    // celdas de puzzle (mezcladas)
    for(let c=0; c<cols; c++){
      const cell = shuffled[idxShuffled];
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      idxShuffled++;
    }

    tbody.appendChild(tr);
  }

  mainTable.appendChild(tbody);
  sheet1.appendChild(mainTable);
  preview.appendChild(sheet1);

  // --- HOJA 2: SOLUCIÓN (imagen armada con números en su lugar) ---
  const sheet2 = document.createElement('div');
  sheet2.className = 'sheet';

  const solTable = document.createElement('table');
  solTable.className = 'puzzle-table';

  const sThead = document.createElement('thead');
  const sHeadRow = document.createElement('tr');
  const sTh = document.createElement('th');
  sTh.colSpan = cols;
  sTh.textContent = "Solución – Puzzle armado con resultados";
  sHeadRow.appendChild(sTh);
  sThead.appendChild(sHeadRow);
  solTable.appendChild(sThead);

  const sTbody = document.createElement('tbody');
  let k = 0;
  for(let r=0; r<rows; r++){
    const tr = document.createElement('tr');
    for(let c=0; c<cols; c++){
      const cell = cells[k]; // imagen en su lugar correcto
      const td = document.createElement('td');
      td.style.position = "relative";

      const img = document.createElement('img');
      img.src = cell.piece;

      const num = document.createElement('div');
      num.textContent = cell.result;
      styleNumber(num);

      td.appendChild(img);
      td.appendChild(num);
      tr.appendChild(td);
      k++;
    }
    sTbody.appendChild(tr);
  }
  solTable.appendChild(sTbody);
  sheet2.appendChild(solTable);
  preview.appendChild(sheet2);

  const note = document.createElement('p');
  note.className = "small-note";
  note.textContent = "Documento generado con Aula Digital QR – Puzzles de Cálculo Mental.";
  preview.appendChild(note);
});

// Botón para generar PDF directo (puzzle + solución)
pdfBtn.addEventListener('click', ()=>{
  if(!preview.firstChild){
    alert("Primero genera un puzzle antes de descargar el PDF.");
    return;
  }

  const element = document.getElementById('preview');
  const opt = {
    margin:       10,
    filename:     'AulaDigitalQR_Puzzle_Matematicas.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { 
      scale: 2,
      // clave: usar el ancho real del contenido
      windowWidth: element.scrollWidth
    },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };
  html2pdf().set(opt).from(element).save();
});
</script>
</body>
</html>
